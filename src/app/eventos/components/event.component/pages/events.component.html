<!-- Backdrop -->
<div class="modal-backdrop fade show"></div>

<!-- Modal -->
<div class="modal fade show d-block" id="eventoModal" tabindex="-1" aria-labelledby="eventoModalLabel" aria-modal="true"
  role="dialog">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">

      <!-- Header -->
      <div class="modal-header">
        <h5 class="modal-title" id="eventoModalLabel">
          {{ estaEditando ? 'Editar Evento' : 'Crear Evento' }}
        </h5>
        <button type="button" class="btn-close" aria-label="Cerrar" (click)="cerrarFormulario.emit()"></button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <form [formGroup]="eventoForm">

          <input type="text" class="form-control" [value]="eventoForm.get('id_programa')?.value" style="display: none;"/>

          <!-- ¿Es institucional? -->
          <div class="mb-3 d-flex align-items-center gap-2">
            <label class="form-label mb-0">¿Es institucional?</label>
            <div class="form-check ms-2">
              <input class="form-check-input" type="radio" formControlName="institucional" [value]="true"
                id="institucionalSi" />
              <label class="form-check-label" for="institucionalSi">Sí</label>
            </div>
            <div class="form-check ms-2">
              <input class="form-check-input" type="radio" formControlName="institucional" [value]="false"
                id="institucionalNo" />
              <label class="form-check-label" for="institucionalNo">No</label>
            </div>
          </div>

          <!-- Selects principales -->
          <div class="row g-2 mb-3">
            <div class="col">
              <label class="form-label">Tipo de evento</label>
              <select class="form-control" formControlName="tipoEvento">
                <option value="" disabled>Selecciona tipo</option>
                @for (tipo of tiposDeActividad; track tipo.id_tipo_actividad) {
                <option [value]="tipo.id_tipo_actividad">{{ tipo.nombre }}</option>
                }
              </select>
            </div>
            <div class="col">
              <label class="form-label">Responsable</label>
              <select class="form-control" formControlName="responsable">
                <option value="" disabled>Selecciona responsable</option>
                @for (r of responsables; track r.id_responsable) {
                <option [value]="r.id_responsable">{{ r.nombre }}</option>
                }
              </select>
            </div>
            <!-- Campo de Aliado con Autocomplete -->
            <div class="col position-relative">
              <label class="form-label">Nombre de aliado</label>
              <input type="text" class="form-control" [value]="aliadoTexto" (input)="onAliadoInput($event)"
              (focus)="!estaEditando && (mostrarSugerencias = true)"
              [readonly]="estaEditando" placeholder="Escribe para buscar" autocomplete="off" />

              <!-- Lista de aliados filtrados -->
              @if (!estaEditando && mostrarSugerencias && aliadosFiltrados.length > 0) {
              <ul class="list-group position-absolute w-100"
                style="z-index: 1050; max-height: 200px; overflow-y: auto;">
                @for (a of aliadosFiltrados; track a) {
                <li class="list-group-item list-group-item-action" (click)="seleccionarAliado(a)">
                  {{ a.nombre }}
                </li>
                }
              </ul>
              }
            </div>

          </div>

          <!-- Nombre del evento -->
          <div class="row g-2 mb-3">
            <div class="col">
              <label class="form-label">Nombre del evento</label>

              @if (esListaNombreEvento() && eventosFiltrados.length > 0) {
                <select class="form-control" formControlName="nombreEvento">
                  <option value="" disabled>Selecciona nombre</option>
                  @for (n of eventosFiltrados; track n.id_parametro_detalle) {
                    <option [value]="n.id_parametro_detalle">{{ n.nombre }}</option>
                  }
                </select>
              }

              <!-- Si corresponde mostrar lista pero NO hay items -->
              @if (esListaNombreEvento() && (!eventosFiltrados || eventosFiltrados.length === 0)) {
              <select class="form-control" disabled>
                <option value="">No hay nombres disponibles para este tipo</option>
              </select>
              }
              <!-- Input libre si la lógica no requiere lista -->
              @if (!esListaNombreEvento()) {
              <input type="text" class="form-control" formControlName="nombreEvento" placeholder="Nombre del evento" />
              }

              @if (eventoForm.get('nombreEvento')?.invalid && eventoForm.get('nombreEvento')?.touched) {
              <div class="text-danger mt-1">
                @if (eventoForm.get('nombreEvento')?.errors?.['required']) {
                <small>El nombre es obligatorio.</small>
                }
              </div>
              }
            </div>

            <!-- Sede -->
            <div class="col-4">
              <label class="form-label">Sede</label>
              <select class="form-control" formControlName="sede">
                <option value="" disabled>Selecciona sede</option>
                @for (s of sedes; track s.id_sede) {
                <option [value]="s.id_sede">{{ s.nombre }}</option>
                }
              </select>
            </div>
          </div>

          <!-- Descripción -->
          <div class="mb-3">
            <label class="form-label">Descripción del evento</label>
            <textarea class="form-control" placeholder="Descripción del evento"
              formControlName="descripcionGrupo"></textarea>
          </div>

          <!-- Frecuencia -->
          <div class="mb-3">
            <label class="form-label">Frecuencia</label>
            <select class="form-control" formControlName="frecuencia">
              <option value="" disabled>Selecciona frecuencia</option>
              @for (f of frecuencias; track f.id_frecuencia) {
              <option [value]="f.id_frecuencia">{{ f.nombre }}</option>
              }
            </select>
          </div>

          <!-- ¿Cuándo? -->
          <label class="form-label mt-3">¿Cuándo?</label>
          <div class="row g-2 align-items-center mb-3">
            <div class="col-4">
              <input type="date" class="form-control" formControlName="fecha" />
            </div>
            <div class="col-3">
              <input type="time" class="form-control" formControlName="horaInicio" />
            </div>
            <div class="col-3">
              <input type="time" class="form-control" formControlName="horaFin" />
            </div>
          </div>
        </form>

        <!-- Grid de sesiones -->
        @if (estaEditando) {
        <app-grid-sesiones [formArray]="sesiones" [soloLectura]="modoSoloLectura"
          [idEvento]="eventoParaEditar?.id || eventoSeleccionado()?.idEvento || null"
          (cambios)="onCambiosSesiones($event)">
        </app-grid-sesiones>
        }
      </div>

      <!-- Footer -->
      @if (!modoSoloLectura) {
      <div class="modal-footer justify-content-center">
        <button class="btn btn-danger rounded-pill px-4" type="button" (click)="guardarEvento()">
          {{ estaEditando ? 'Actualizar' : 'Guardar' }}
        </button>
      </div>
      }

    </div>
  </div>
</div>
